<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Property Dashboard</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .chart-container {
            margin: 20px 0;
        }
    </style>
    <script>
        function handleRegionClick(region) {
            console.log("Region clicked: " + region);
            document.getElementById("region_select").value = region;
            document.getElementById("property_form").submit();
        }

        function updatePostcodes() {
            var region = document.getElementById("region_select").value;
            fetch('/get_postcodes?region=' + encodeURIComponent(region))
                .then(response => response.json())
                .then(postcodes => {
                    var postcodeSelect = document.getElementById("postcode_select");
                    postcodeSelect.innerHTML = '<option value="">Select Postcode</option>';
                    postcodes.forEach(pc => {
                        postcodeSelect.innerHTML += `<option value="${pc}">${pc}</option>`;
                    });
                    updateSuburbs();
                });
        }

        function updateSuburbs() {
            var region = document.getElementById("region_select").value;
            var postcode = document.getElementById("postcode_select").value;
            fetch('/get_suburbs?region=' + encodeURIComponent(region) + '&postcode=' + encodeURIComponent(postcode))
                .then(response => response.json())
                .then(suburbs => {
                    var suburbSelect = document.getElementById("suburb_select");
                    suburbSelect.innerHTML = '<option value="">Select Suburb</option>';
                    suburbs.forEach(suburb => {
                        suburbSelect.innerHTML += `<option value="${suburb}">${suburb}</option>`;
                    });
                });
        }
    </script>
</head>
<body>
    <h1>Property Dashboard</h1>
    <p>Data Source: {{ data_source }}</p>
    <a href="/hot_suburbs">View Hot Suburbs</a>

    <form method="POST" id="property_form">
        <label for="region_select">Region:</label>
        <select name="region" id="region_select" onchange="updatePostcodes()">
            <option value="">Select Region</option>
            {% for region in regions %}
                <option value="{{ region }}" {% if region == selected_region %}selected{% endif %}>{{ region }}</option>
            {% endfor %}
        </select>

        <label for="postcode_select">Postcode:</label>
        <select name="postcode" id="postcode_select" onchange="updateSuburbs()">
            <option value="">Select Postcode</option>
            {% for postcode in postcodes %}
                <option value="{{ postcode }}" {% if postcode == selected_postcode %}selected{% endif %}>{{ postcode }}</option>
            {% endfor %}
        </select>

        <label for="suburb_select">Suburb:</label>
        <select name="suburb" id="suburb_select">
            <option value="">Select Suburb</option>
            {% for suburb in suburbs %}
                <option value="{{ suburb }}" {% if suburb == selected_suburb %}selected{% endif %}>{{ suburb }}</option>
            {% endfor %}
        </select>

        <label for="property_type_select">Property Type:</label>
        <select name="property_type" id="property_type_select">
            {% for pt in property_types %}
                <option value="{{ pt }}" {% if pt == selected_property_type %}selected{% endif %}>{{ pt }}</option>
            {% endfor %}
        </select>

        <label for="sort_by_select">Sort By:</label>
        <select name="sort_by" id="sort_by_select">
            <option value="Settlement Date" {% if sort_by == "Settlement Date" %}selected{% endif %}>Settlement Date</option>
            <option value="Price" {% if sort_by == "Price" %}selected{% endif %}>Price</option>
            <option value="Address" {% if sort_by == "Address" %}selected{% endif %}>Address</option>
        </select>

        <input type="submit" value="Filter">
    </form>

    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}

    {% if heatmap_path %}
        <div class="chart-container">
            <h2>Heatmap</h2>
            <iframe src="{{ heatmap_path }}" width="100%" height="600"></iframe>
        </div>
    {% endif %}

    {% if hot_suburbs %}
        <h2>Hot Suburbs (Median Price < $900,000)</h2>
        <table>
            <tr>
                <th>Suburb</th>
                <th>Postcode</th>
                <th>Region</th>
                <th>Median Price</th>
            </tr>
            {% for suburb in hot_suburbs %}
            <tr>
                <td>
                    <form method="POST" action="/" style="display:inline;">
                        <input type="hidden" name="suburb" value="{{ suburb.Suburb }}">
                        <input type="hidden" name="property_type" value="HOUSE">
                        <input type="hidden" name="sort_by" value="Settlement Date">
                        <a href="#" onclick="this.parentNode.submit(); return false;">{{ suburb.Suburb }}</a>
                    </form>
                </td>
                <td>{{ suburb.Postcode }}</td>
                <td>{{ suburb.Region }}</td>
                <td>${{ suburb.Price | int }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endif %}

    {% if properties %}
        <h2>Properties (Average Price: ${{ avg_price | int }})</h2>
        <p>Stats - Mean: ${{ stats.mean | int }}, Median: ${{ stats.median | int }}, Std Dev: ${{ stats.std | int }}</p>
        <table>
            <tr>
                <th>Address</th>
                <th>Price</th>
                <th>Settlement Date</th>
                <th>Block Size (mÂ²)</th>
                <th>Map Link</th>
            </tr>
            {% for prop in properties %}
            <tr>
                <td>{{ prop.Address }}</td>
                <td>${{ prop.Price | int }}</td>
                <td>{{ prop["Settlement Date"] }}</td>
                <td>{{ prop["Block Size"] | default('N/A') }}</td>
                <td><a href="{{ prop['Map Link'] }}" target="_blank">View on Map</a></td>
            </tr>
            {% endfor %}
        </table>
    {% endif %}

    {% if median_chart_path %}
        <div class="chart-container">
            <h2>Median House Price Over Time</h2>
            <img src="{{ median_chart_path }}" alt="Median House Price Chart">
        </div>
    {% endif %}

    {% if price_hist_path %}
        <div class="chart-container">
            <h2>Price Histogram</h2>
            <img src="{{ price_hist_path }}" alt="Price Histogram">
        </div>
    {% endif %}

    {% if region_timeline_path %}
        <div class="chart-container">
            <h2>Region Price Timeline</h2>
            <img src="{{ region_timeline_path }}" alt="Region Timeline">
        </div>
    {% endif %}

    {% if postcode_timeline_path %}
        <div class="chart-container">
            <h2>Postcode Price Timeline</h2>
            <img src="{{ postcode_timeline_path }}" alt="Postcode Timeline">
        </div>
    {% endif %}

    {% if suburb_timeline_path %}
        <div class="chart-container">
            <h2>Suburb Price Timeline</h2>
            <img src="{{ suburb_timeline_path }}" alt="Suburb Timeline">
        </div>
    {% endif %}

    {% if region_median_chart_path %}
        <div class="chart-container">
            <h2>Median Price by Region</h2>
            <img src="{{ region_median_chart_path }}" alt="Region Median Prices">
        </div>
    {% endif %}

    {% if postcode_median_chart_path %}
        <div class="chart-container">
            <h2>Median Price by Postcode</h2>
            <img src="{{ postcode_median_chart_path }}" alt="Postcode Median Prices">
        </div>
    {% endif %}

    {% if suburb_median_chart_path %}
        <div class="chart-container">
            <h2>Median Price by Suburb</h2>
            <img src="{{ suburb_median_chart_path }}" alt="Suburb Median Prices">
        </div>
    {% endif %}
</body>
</html>